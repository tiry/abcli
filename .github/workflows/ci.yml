name: CI

on:
  push:
    branches: [master]
    paths-ignore:
      - 'badges/**'
  pull_request:
    branches: [master]
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  lint:
    name: Linting
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f pyproject.toml ]; then pip install -e .[dev]; fi
      - name: Run lint.sh script
        run: ./lint.sh

  test-cli:
    name: CLI Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f pyproject.toml ]; then pip install -e .[dev]; fi
      - name: Run CLI tests with coverage
        run: |
          pytest tests/test_api/ tests/test_cli/ tests/test_config/ tests/test_models/ --cov=ab_cli --cov-report=term --cov-report=xml:coverage_cli.xml
          
      # Generate Coverage Report and Badge for CLI
      - name: Code Coverage Summary for CLI
        uses: irongut/CodeCoverageSummary@v1.3.0
        with:
          filename: coverage_cli.xml
          badge: true
          format: markdown
          output: both
          
      # Create coverage badge for CLI
      - name: Download CLI coverage badge
        run: |
          mkdir -p .github
          # Extract the coverage percentage from the XML file
          COVERAGE_PCT=$(grep -oP 'line-rate="\K[^"]+' coverage_cli.xml | head -1 | awk '{printf "%.0f", $1 * 100}')
          # Determine the color based on coverage percentage
          if [ "$COVERAGE_PCT" -lt 50 ]; then
            COLOR="red"
          elif [ "$COVERAGE_PCT" -lt 75 ]; then
            COLOR="yellow"
          else
            COLOR="success"
          fi
          # Download the badge from shields.io
          curl -s -o .github/coverage.svg "https://img.shields.io/badge/CLI%20Coverage-${COVERAGE_PCT}%25-${COLOR}?style=flat"
          
      - name: Upload CLI coverage badge
        uses: actions/upload-artifact@v4
        with:
          name: coverage-badge-cli
          path: .github/coverage.svg

  test-ui:
    name: UI Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f pyproject.toml ]; then pip install -e .[dev]; fi
      - name: Run UI tests with coverage
        run: |
          pytest tests/test_abui/ --cov=ab_cli.abui --cov-report=term --cov-config=/dev/null --cov-report=xml:coverage_ui.xml
          
      # Generate Coverage Report and Badge for UI
      - name: Code Coverage Summary for UI
        uses: irongut/CodeCoverageSummary@v1.3.0
        with:
          filename: coverage_ui.xml
          badge: true
          format: markdown
          output: both
          
      # Create coverage badge for UI
      - name: Download UI coverage badge
        run: |
          mkdir -p .github
          # Extract the coverage percentage from the XML file
          COVERAGE_PCT=$(grep -oP 'line-rate="\K[^"]+' coverage_ui.xml | head -1 | awk '{printf "%.0f", $1 * 100}')
          # Determine the color based on coverage percentage
          if [ "$COVERAGE_PCT" -lt 50 ]; then
            COLOR="red"
          elif [ "$COVERAGE_PCT" -lt 75 ]; then
            COLOR="yellow"
          else
            COLOR="success"
          fi
          # Download the badge from shields.io
          curl -s -o .github/coverage_ui.svg "https://img.shields.io/badge/UI%20Coverage-${COVERAGE_PCT}%25-${COLOR}?style=flat"
          
      - name: Upload UI coverage badge
        uses: actions/upload-artifact@v4
        with:
          name: coverage-badge-ui
          path: .github/coverage_ui.svg

  build:
    name: Build Package
    needs: [lint, test-cli, test-ui]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip build
          if [ -f pyproject.toml ]; then pip install -e .[dev]; fi
          
      - name: Show environment and working directory
        run: |
          echo "Current working directory: $(pwd)"
          echo "Python version: $(python --version)"
          echo "Build tool version: $(python -m build --version)"
          echo "Content of current directory:"
          ls -la
          
      - name: Build package
        run: |
          python -m build
          echo "Content of dist directory after build:"
          ls -la dist/
          find dist -type f -exec ls -la {} \;
          
      - name: Upload entire dist directory
        uses: actions/upload-artifact@v4
        with:
          name: python-package-all
          path: dist/
          if-no-files-found: error
          
      - name: Upload Python package (wheel)
        uses: actions/upload-artifact@v4
        with:
          name: python-package-wheel
          path: dist/*.whl
          if-no-files-found: error
          
      - name: Upload Python package (sdist)
        uses: actions/upload-artifact@v4
        with:
          name: python-package-sdist
          path: dist/*.tar.gz
          if-no-files-found: error
          
      # As a final safety check, verify the package artifacts
      - name: Verify artifacts
        run: |
          echo "Verifying wheel package:"
          WHEEL_COUNT=$(find dist -name "*.whl" | wc -l)
          echo "Found $WHEEL_COUNT wheel files"
          
          echo "Verifying source package:"
          SDIST_COUNT=$(find dist -name "*.tar.gz" | wc -l)
          echo "Found $SDIST_COUNT source distribution files"
          
          if [ "$WHEEL_COUNT" -eq 0 ] || [ "$SDIST_COUNT" -eq 0 ]; then
            echo "ERROR: Missing package artifacts!"
            exit 1
          else
            echo "All package artifacts found."
          fi

  update-badges:
    name: Update Badges
    if: github.event_name == 'push' && github.ref == 'refs/heads/master'
    needs: [test-cli, test-ui]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout badges branch
        uses: actions/checkout@v4
        with:
          ref: badges
          fetch-depth: 0
          
      - name: Download CLI coverage badge
        uses: actions/download-artifact@v4
        with:
          name: coverage-badge-cli
          path: .
          
      - name: Download UI coverage badge
        uses: actions/download-artifact@v4
        with:
          name: coverage-badge-ui
          path: .
          
      - name: Commit and push badges
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # Add the badges
          git add coverage.svg coverage_ui.svg
          
          # Only commit if there are changes
          git diff --quiet && git diff --staged --quiet || git commit -m "Update coverage badges"
          
          # Push to badges branch
          git push